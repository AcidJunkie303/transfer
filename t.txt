param(
  [Parameter(Mandatory=$true)]
  [string] $SiteName,

  # 1 year is a common starting point (in seconds)
  [uint32] $MaxAgeSeconds = 31536000,

  [switch] $IncludeSubDomains,

  # IIS site-level redirect (replaces scheme with https and ignores port; expects HTTPS on 443)
  [switch] $RedirectHttpToHttps,

  # Only enable if you have submitted the domain to the HSTS preload list
  [switch] $Preload
)

Import-Module IISAdministration
Reset-IISServerManager -Confirm:$false
Start-IISCommitDelay

$sitesCollection = Get-IISConfigSection -SectionPath "system.applicationHost/sites" | Get-IISConfigCollection
$siteElement = Get-IISConfigCollectionElement -ConfigCollection $sitesCollection -ConfigAttribute @{ name = $SiteName }

if (-not $siteElement) {
  throw "IIS site '$SiteName' not found."
}

$hstsElement = Get-IISConfigElement -ConfigElement $siteElement -ChildElementName "hsts"

Set-IISConfigAttributeValue -ConfigElement $hstsElement -AttributeName "enabled" -AttributeValue $true
Set-IISConfigAttributeValue -ConfigElement $hstsElement -AttributeName "max-age" -AttributeValue $MaxAgeSeconds

Set-IISConfigAttributeValue -ConfigElement $hstsElement -AttributeName "includeSubDomains" -AttributeValue ([bool]$IncludeSubDomains)
Set-IISConfigAttributeValue -ConfigElement $hstsElement -AttributeName "redirectHttpToHttps" -AttributeValue ([bool]$RedirectHttpToHttps)
Set-IISConfigAttributeValue -ConfigElement $hstsElement -AttributeName "preload" -AttributeValue ([bool]$Preload)

Stop-IISCommitDelay
Remove-Module IISAdministration
