using Microsoft.OpenApi.Models;
using Swashbuckle.AspNetCore.SwaggerGen;

public sealed class FileUploadOperationFilter : IOperationFilter
{
    public void Apply(OpenApiOperation operation, OperationFilterContext context)
    {
        // If you only want to target this deploy endpoint, filter by route or OperationId
        var path = context.ApiDescription.RelativePath; // e.g. "MyService/{bla}/deploy"
        if (!string.Equals(path, "MyService/{bla}/deploy", StringComparison.OrdinalIgnoreCase))
            return;

        if (operation.RequestBody == null)
            return;

        if (!operation.RequestBody.Content.TryGetValue("multipart/form-data", out var mediaType))
            return;

        // Force correct multipart schema: object with "file" property
        mediaType.Schema = new OpenApiSchema
        {
            Type = "object",
            Required = { "file" },
            Properties =
            {
                ["file"] = new OpenApiSchema
                {
                    Type = "string",
                    Format = "binary"
                }
            }
        };
    }
}
