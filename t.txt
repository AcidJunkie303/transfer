using System;
using System.Collections.Generic;
using System.Linq;

public static class LinqJoinExtensions
{
    public static IEnumerable<TResult> FullOuterJoin<TLeft, TRight, TKey, TResult>(
        this IEnumerable<TLeft> left,
        IEnumerable<TRight> right,
        Func<TLeft, TKey> leftKeySelector,
        Func<TRight, TKey> rightKeySelector,
        Func<TLeft?, TRight?, TKey, TResult> resultSelector,
        IEqualityComparer<TKey>? comparer = null)
        where TLeft : class
        where TRight : class
    {
        ArgumentNullException.ThrowIfNull(left);
        ArgumentNullException.ThrowIfNull(right);
        ArgumentNullException.ThrowIfNull(leftKeySelector);
        ArgumentNullException.ThrowIfNull(rightKeySelector);
        ArgumentNullException.ThrowIfNull(resultSelector);

        var leftLookup  = left.ToLookup(leftKeySelector, comparer);
        var rightLookup = right.ToLookup(rightKeySelector, comparer);

        var keys = new HashSet<TKey>(leftLookup.Select(g => g.Key), comparer);
        keys.UnionWith(rightLookup.Select(g => g.Key));

        foreach (var key in keys)
        {
            var lefts  = leftLookup[key].DefaultIfEmpty(null);
            var rights = rightLookup[key].DefaultIfEmpty(null);

            foreach (var l in lefts)
            foreach (var r in rights)
                yield return resultSelector(l, r, key);
        }
    }
}
